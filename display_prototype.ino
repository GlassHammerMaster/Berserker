#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// OLED display dimensions
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1

int buttonPin1 = 15; // up
int buttonPin2 = 18; // down
int buttonPin3 = 12; // select
int buttonPin4 = 35;

// Menu variables
int selectedOption = 0;
int scrollOffset = 0;          // NEW: first visible option
int menuStartX = 0;
int menuStartY = 10;
int menuLineHeight = 10;

const char* options[] = {
  "Test 1",
  "Test 2",
  "Test 3",
  "Test 4",
  "Test 5",
  "Test 6",
  "Test 7",
  "Test 8"
};

const int optionCount = sizeof(options) / sizeof(options[0]);

// How many lines fit on screen
const int visibleLines = (SCREEN_HEIGHT - menuStartY) / menuLineHeight;

const unsigned char logoBitmap[] PROGMEM = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x03,0xC0,0x00,0x00,0x00,
  0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
  0x00,0x00,0x00,0x1F,0xF8,0x00,0x00,0x00,

  0x00,0x00,0x00,0x3F,0xFC,0x00,0x00,0x00,
  0x00,0x00,0x00,0x7F,0xFE,0x00,0x00,0x00,
  0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
  0x00,0x00,0x01,0xFF,0xFF,0x80,0x00,0x00,

  0x00,0x00,0x03,0xF8,0x1F,0xC0,0x00,0x00,
  0x00,0x00,0x07,0xE0,0x07,0xE0,0x00,0x00,
  0x00,0x00,0x0F,0xC0,0x03,0xF0,0x00,0x00,
  0x00,0x00,0x1F,0x80,0x01,0xF8,0x00,0x00,

  0x00,0x00,0x3F,0x00,0x00,0xFC,0x00,0x00,
  0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,
  0x00,0x00,0xFC,0x00,0x00,0x3F,0x00,0x00,
  0x00,0x01,0xF8,0x00,0x00,0x1F,0x80,0x00,

  0x00,0x03,0xF0,0x00,0x00,0x0F,0xC0,0x00,
  0x00,0x07,0xE0,0x00,0x00,0x07,0xE0,0x00,
  0x00,0x0F,0xC0,0x00,0x00,0x03,0xF0,0x00,
  0x00,0x1F,0x80,0x00,0x00,0x01,0xF8,0x00,

  0x00,0x3F,0x00,0x00,0x00,0x00,0xFC,0x00,
  0x00,0x7E,0x00,0x00,0x00,0x00,0x7E,0x00,
  0x00,0xFC,0x00,0x00,0x00,0x00,0x3F,0x00,
  0x01,0xF8,0x00,0x00,0x00,0x00,0x1F,0x80,

  0x03,0xF0,0x00,0x00,0x00,0x00,0x0F,0xC0,
  0x07,0xE0,0x00,0x00,0x00,0x00,0x07,0xE0,
  0x0F,0xC0,0x00,0x00,0x00,0x00,0x03,0xF0,
  0x1F,0x80,0x00,0x00,0x00,0x00,0x01,0xF8,

  0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,
  0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,
  0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,
  0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,

  0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,
  0x1F,0x80,0x00,0x00,0x00,0x00,0x01,0xF8,
  0x0F,0xC0,0x00,0x00,0x00,0x00,0x03,0xF0,
  0x07,0xE0,0x00,0x00,0x00,0x00,0x07,0xE0,

  0x03,0xF0,0x00,0x00,0x00,0x00,0x0F,0xC0,
  0x01,0xF8,0x00,0x00,0x00,0x00,0x1F,0x80,
  0x00,0xFC,0x00,0x00,0x00,0x00,0x3F,0x00,
  0x00,0x7E,0x00,0x00,0x00,0x00,0x7E,0x00,

  0x00,0x3F,0x00,0x00,0x00,0x00,0xFC,0x00,
  0x00,0x1F,0x80,0x00,0x00,0x01,0xF8,0x00,
  0x00,0x0F,0xC0,0x00,0x00,0x03,0xF0,0x00,
  0x00,0x07,0xE0,0x00,0x00,0x07,0xE0,0x00,

  0x00,0x03,0xF0,0x00,0x00,0x0F,0xC0,0x00,
  0x00,0x01,0xF8,0x00,0x00,0x1F,0x80,0x00,
  0x00,0x00,0xFC,0x00,0x00,0x3F,0x00,0x00,
  0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,

  0x00,0x00,0x3F,0x00,0x00,0xFC,0x00,0x00,
  0x00,0x00,0x1F,0x80,0x01,0xF8,0x00,0x00,
  0x00,0x00,0x0F,0xC0,0x03,0xF0,0x00,0x00,
  0x00,0x00,0x07,0xE0,0x07,0xE0,0x00,0x00,

  0x00,0x00,0x03,0xF0,0x0F,0xC0,0x00,0x00,
  0x00,0x00,0x01,0xF8,0x1F,0x80,0x00,0x00,
  0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
  0x00,0x00,0x00,0x7F,0xFE,0x00,0x00,0x00,

  0x00,0x00,0x00,0x3F,0xFC,0x00,0x00,0x00,
  0x00,0x00,0x00,0x1F,0xF8,0x00,0x00,0x00,
  0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
  0x00,0x00,0x00,0x03,0xC0,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

void drawMenu();

void setup() {
  Serial.begin(115200);

  pinMode(buttonPin1, INPUT_PULLUP);
  pinMode(buttonPin2, INPUT_PULLUP);
  pinMode(buttonPin3, INPUT_PULLUP);
  pinMode(buttonPin4, INPUT_PULLUP);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;);
  }
  drawLogo();
  drawMenu();
}

void loop() {
  // UP button
  if (digitalRead(buttonPin1) == LOW) {
    selectedOption--;
    if (selectedOption < 0) selectedOption = optionCount - 1;

    // Scroll up if needed
    if (selectedOption < scrollOffset) {
      scrollOffset = selectedOption;
    }

    drawMenu();
    delay(150);
  }

  // DOWN button
  if (digitalRead(buttonPin2) == LOW) {
    selectedOption++;
    if (selectedOption >= optionCount) selectedOption = 0;

    // Scroll down if needed
    if (selectedOption >= scrollOffset + visibleLines) {
      scrollOffset = selectedOption - visibleLines + 1;
    }

    drawMenu();
    delay(150);
  }

  // SELECT button
  if (digitalRead(buttonPin3) == LOW) {
    Serial.print("Selected: ");
    Serial.println(options[selectedOption]);
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 32);
    display.println("Selected: ");
    display.println(options[selectedOption]);
    display.display();
    delay(200);
  }
}

void drawMenu() {
  display.clearDisplay();

  // Draw only visible options
  for (int i = 0; i < visibleLines; i++) {
    int optionIndex = scrollOffset + i;
    if (optionIndex >= optionCount) break;

    int y = menuStartY + i * menuLineHeight;

    if (optionIndex == selectedOption) {
      display.setTextColor(SSD1306_BLACK, SSD1306_WHITE);
    } else {
      display.setTextColor(SSD1306_WHITE);
    }

    display.setCursor(menuStartX, y);
    display.println(options[optionIndex]);
  }

  display.display();
}

void drawLogo() {
  display.clearDisplay();
  display.setCursor(0, 32);
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.println("Black Diamond V0.1");
  display.display();
  delay(2000);
  display.clearDisplay();
  display.drawBitmap(32,0,logoBitmap,64,64,SSD1306_WHITE);
  display.display();
  delay(4000);
}
